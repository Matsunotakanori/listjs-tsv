<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddHHyTfAAsrekwKmP1" crossorigin="anonymous">
  <link media="all" href="css/4listjs.css" type="text/css" rel="stylesheet">
  <title>Lits.jsとTSVによる「１万件」書誌検索サンプルページ</title>
</head>
<body class="container">
  <h1 id="top">List.jsとTSVによる「１万件」書誌検索サンプルページ</h1>
  <p>
    List.jsとTSVで「１万件」程度の書誌検索サンプルページを作ってみました。
    <br><br>
    Code は<a href="https://github.com/maedaak/listjs-tsv/" target="_blank">こちら</a>にあります。
    より詳しくは<a href="https://github.com/maedaak/listjs-tsv/blob/main/Readme.md" target="_blank">Readme.md</a>をご参照ください。
  </p>

  <div id="listdata">
    <div class="form-group row">
      <label for="keyword">文字列をタイプ　<span class="alert">※　半角スペース区切りでAND検索可能</span></label>
      <div class="col-md-8">
        <input id="keyword" class="search form-control form-control-lg" placeholder="input any word" size="50" />
      </div>
      <div class="col-md-4">
        <select id="lang" class="form-control form-control-lg">
          <option value="any"> --- </option>
          <option value="eng">英語</option>
          <option value="ger">ドイツ語</option>
          <option value="chi">中国語</option>
        </select>
      </div>
    </div>
    <span id="hits"></span>
    
    <ul class="list list-unstyled">
      </ul>
    
    <div class="form-group">
      <ul class="pagination list-inline"></ul>
    </div>
  </div>

  <hr>

  <footer>
    <a href="#top">ページトップへ</a>
  </footer>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/list.fuzzysearch.js/0.1.0/list.fuzzysearch.min.js"></script>
  <script src = "https://d3js.org/d3.v7.min.js"></script>
  <script>
    const input_file = "current_dump.tsv";

    d3.tsv(input_file).then(function(values) {
      const fuzzyOptions = {
        searchClass: "fuzzy-search",
        location: 0,
        distance: 100,
        threshold: 0.4,
        multiSearch: true
      };

      const options = {
        valueNames: ['title', 'auth', 'pub', 'pub_year', 'language'],
        
        // ここを修正: item オプションでテンプレート文字列を直接指定
        item: `
          <li class="list-item">
            <p class="horizon"></p>
            <dl>
              <dt class="title"></dt>
              <dd class="auth"></dd>
              <dd class="pub"></dd>
              <dd class="pub_year"></dd>
            </dl>
          </li>
        `,
        
        plugins: [
          ListFuzzySearch(fuzzyOptions)
        ],
        searchDelay: 750,
        page: 20,
        pagination: {
          paginationClass: 'pagination',
          innerWindow: 2,
          outerWindow: 1,
          item: '<li class="page-item"><a class="page page-link" href="#"></a></li>',
        }
      };

      const listObj = new List('listdata', options, values);

      // 検索イベント
      $('#keyword').on('input', function() {
        const searchString = $(this).val();
        listObj.search(searchString);
        $('#hits').html(listObj.matchingItems.length + "件ヒットしました");
      });

      // フィルターイベント
      $('#lang').change(function() {
        const lang = $(this).val();
        listObj.filter(function(item) {
          if (lang === 'any') {
            return true;
          }
          // language プロパティが 'eng' 'ger' 'chi' のいずれかと一致する場合にtrueを返す
          return item.values().language === lang;
        });
        $('#hits').html(listObj.matchingItems.length + "件ヒットしました");
      });

      // 初期表示時のヒット件数を表示
      $('#hits').html(listObj.matchingItems.length + "件ヒットしました");

    }).catch(function(error){
      console.error("データの読み込み中にエラーが発生しました:", error);
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.min.js" integrity="sha384-pQQkAEnwaBkjpqZ8RU1fF1AKtTcHJwFl3pblpTlHXybJjHpMYo79HY3hIi4NKxyj" crossorigin="anonymous"></script>
</body>
</html>
